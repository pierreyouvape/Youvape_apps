{
  "test_date": "2026-01-30T11:00:00Z",
  "duration_minutes": 45,
  "test_type": "ACTIVE - avec donn√©es simul√©es",
  "summary": {
    "total_checks": 15,
    "checks_passed": 12,
    "checks_failed": 0,
    "warnings": 3,
    "critical_issues": [],
    "warnings_list": [
      "Queue inactive depuis le 26 d√©cembre 2025 (>1 mois)",
      "Logs montrent des √©v√©nements dupliqu√©s (faux positifs - d√©duplication fonctionne)",
      "Divergence de 13.4% entre les commandes WP et PG (historique non synchronis√©)"
    ],
    "info": [
      "Plugin YouSync actif et fonctionnel",
      "Service wcSync op√©rationnel (polling toutes les 60s)",
      "Int√©grit√© des donn√©es excellente"
    ]
  },
  "initial_snapshot": {
    "wordpress_stats": {
      "orders": 146474,
      "products": 2737,
      "product_variations": 4615,
      "users": 53593,
      "total_products_with_variations": 7352
    },
    "postgresql_stats": {
      "orders": 126892,
      "products": 7348,
      "customers": 51929,
      "order_items": 650822,
      "refunds": 983
    }
  },
  "divergence_analysis": {
    "orders": {
      "wp_count": 146474,
      "pg_count": 126892,
      "difference": 19582,
      "percentage": "13.4%",
      "status": "WARNING",
      "explanation": "Commandes anciennes non synchronis√©es (import initial partiel probable)"
    },
    "products": {
      "wp_count": 7352,
      "pg_count": 7348,
      "difference": 4,
      "percentage": "0.05%",
      "status": "OK"
    },
    "customers": {
      "wp_count": 53593,
      "pg_count": 51929,
      "difference": 1664,
      "percentage": "3.1%",
      "status": "OK"
    }
  },
  "queue_status": {
    "events_count": 0,
    "last_modified": "2025-12-26T16:45:37Z",
    "days_since_activity": 35,
    "status": "STALE"
  },
  "integrity_checks": {
    "queue_integrity": {
      "status": "PASS",
      "details": "Queue vide mais format valide"
    },
    "wordpress_pg_consistency": {
      "status": "PASS",
      "details": "√âchantillons de 10 produits et 5 commandes parfaitement identiques"
    },
    "metadata_consistency": {
      "status": "PASS",
      "details": "SKU, prix, stock, statuts tous coh√©rents"
    },
    "data_anomalies": {
      "future_dates": 0,
      "null_wp_ids": 0,
      "negative_prices": 0,
      "negative_stock": 1,
      "negative_totals": 0,
      "orphan_items": 0,
      "orders_without_items": 1,
      "details": "1 produit avec stock n√©gatif (coh√©rent avec WP), 1 commande annul√©e sans items (normal)"
    }
  },
  "hook_behavior_analysis": {
    "duplicates_in_logs": {
      "status": "FALSE_POSITIVE",
      "details": "Les logs montrent plusieurs 'Event queued' pour le m√™me ID, mais la d√©duplication dans Queue_Manager::add() fonctionne correctement. Le log s'affiche avant la logique de merge, cr√©ant une impression de doublons.",
      "evidence": [
        "order #1181043: 4 logs √† 12:07:53-54 (1 seul event en queue)",
        "product #11152: 3 logs √† 17:41:15 (1 seul event en queue)"
      ],
      "recommendation": "Modifier le log pour distinguer 'Event queued' vs 'Event updated'"
    },
    "ghost_events": {
      "status": "PASS",
      "details": "Pas d'√©v√©nements fant√¥mes d√©tect√©s"
    },
    "cross_entity_contamination": {
      "status": "PASS",
      "details": "Pas de contamination d√©tect√©e"
    }
  },
  "wc_sync_service_status": {
    "service_running": true,
    "interval_seconds": 60,
    "wp_url_configured": "https://youvape-site-traefik-1",
    "wp_url_accessible": true,
    "token_valid": true,
    "polling_functional": true,
    "last_known_activity": "2025-12-26T17:45:37Z",
    "reason_no_recent_activity": "Queue WordPress vide - pas de nouvelles modifications depuis le 26/12/2025"
  },
  "issues_found": [
    {
      "id": 1,
      "severity": "warning",
      "type": "inactivit√©",
      "description": "La queue YouSync n'a pas eu d'activit√© depuis le 26 d√©cembre 2025 (35 jours)",
      "evidence": {
        "queue_last_modified": "2025-12-26T16:45:37Z",
        "last_log_entry": "[17:45:37] Queue ack by VPS: 1 events removed"
      },
      "impact": "Les modifications faites sur WordPress depuis cette date ne sont pas synchronis√©es vers PostgreSQL",
      "recommendation": "V√©rifier si des commandes/produits ont √©t√© modifi√©s sur WP depuis le 26/12 et si oui, investiguer pourquoi les hooks ne d√©clenchent pas"
    },
    {
      "id": 2,
      "severity": "info",
      "type": "log_misleading",
      "description": "Les logs affichent 'Event queued' m√™me lors d'une mise √† jour (d√©duplication)",
      "evidence": {
        "code_location": "class-queue-manager.php::add()",
        "log_line": "Logger::log('info', sprintf('Event queued: %s %s #%d', ...))"
      },
      "impact": "Peut cr√©er de la confusion lors du debugging",
      "recommendation": "Changer le log en 'Event queued/updated: %s %s #%d' selon $found"
    },
    {
      "id": 3,
      "severity": "info",
      "type": "divergence_historique",
      "description": "19,582 commandes pr√©sentes dans WordPress mais absentes de PostgreSQL",
      "evidence": {
        "wp_orders": 146474,
        "pg_orders": 126892
      },
      "impact": "Les statistiques bas√©es sur PostgreSQL ne refl√®tent pas 100% des commandes",
      "recommendation": "Lancer un import historique si les anciennes commandes sont n√©cessaires pour les analyses"
    }
  ],
  "performance_metrics": {
    "queue_growth_rate": "0 events/day (inactive)",
    "average_poll_time_ms": "< 100ms (queue vide)",
    "wp_endpoint_response_time_ms": "~50ms",
    "service_uptime": "OK (running since container start)"
  },
  "security_checks": {
    "token_exposed_in_logs": false,
    "htaccess_protection": true,
    "endpoint_requires_token": true
  },
  "yousync_configuration": {
    "enabled": true,
    "api_url": "http://54.37.156.233:3000/api/webhook/sync",
    "cron_interval": 1,
    "batch_size": 50,
    "retry_hours": 24,
    "sync_orders": true,
    "sync_products": true,
    "sync_customers": true,
    "sync_refunds": true
  },
  "recommendations": [
    {
      "priority": "HIGH",
      "action": "Investiguer pourquoi aucun √©v√©nement n'est g√©n√©r√© depuis le 26/12/2025",
      "details": "V√©rifier les logs WordPress, les hooks WooCommerce, et si des modifications ont √©t√© faites sur le site"
    },
    {
      "priority": "MEDIUM",
      "action": "Am√©liorer le logging pour distinguer 'queued' vs 'updated'",
      "details": "Modifier Queue_Manager::add() pour logger diff√©remment selon $found"
    },
    {
      "priority": "LOW",
      "action": "Ajouter un log p√©riodique de heartbeat dans wcSyncService",
      "details": "Afficher 'üîÑ WC Sync: polling OK (0 events)' toutes les 10 minutes pour confirmer que le service tourne"
    }
  ],
  "conclusion": "Le syst√®me YouSync est techniquement fonctionnel et l'int√©grit√© des donn√©es est excellente. Le probl√®me principal est l'inactivit√© de la queue depuis le 26 d√©cembre 2025, ce qui sugg√®re soit une absence de modifications sur WordPress, soit un probl√®me avec les hooks WooCommerce qui ne d√©clenchent plus les √©v√©nements.",

  "active_tests": {
    "test_date": "2026-01-30T11:08:00Z",
    "tests_performed": [
      {
        "test": "Cr√©ation commande",
        "order_id": 1181082,
        "customer": "pierre.merle.723@gmail.com",
        "result": "SUCCESS",
        "events_logged": 5,
        "events_in_queue": 1,
        "sync_time_seconds": 41,
        "notes": "5 logs (1 create + 4 update) mais 1 seul √©v√©nement en queue gr√¢ce √† la d√©duplication"
      },
      {
        "test": "Changement statut commande",
        "order_id": 1181082,
        "status_change": "pending ‚Üí processing",
        "result": "SUCCESS",
        "events_generated": 2,
        "notes": "1 √©v√©nement order + 1 √©v√©nement product (stock d√©cr√©ment√© automatiquement)"
      },
      {
        "test": "Modification stock produit",
        "product_id": 1173258,
        "stock_change": "19 ‚Üí 999 ‚Üí 19",
        "result": "SUCCESS",
        "sync_verified": true,
        "notes": "Stock synchronis√© correctement, mais updated_at non mis √† jour dans PostgreSQL"
      }
    ],
    "summary": {
      "all_tests_passed": true,
      "sync_working": true,
      "deduplication_working": true,
      "average_sync_time_seconds": 40
    },
    "bugs_found": [
      {
        "severity": "minor",
        "description": "Le champ updated_at des produits n'est pas mis √† jour lors du sync",
        "impact": "Impossible de savoir quand un produit a √©t√© synchronis√© pour la derni√®re fois",
        "location": "wcSyncService.js::processProduct()"
      },
      {
        "severity": "info",
        "description": "Logs multiples pour une seule action (5 logs pour 1 cr√©ation de commande)",
        "impact": "Confusion lors du debugging, mais pas d'impact fonctionnel",
        "location": "class-queue-manager.php::add()"
      }
    ],
    "confirmation": "Le syst√®me YouSync fonctionne correctement. L'inactivit√© pr√©c√©dente (depuis le 26/12/2025) √©tait due √† l'absence de modifications sur le site pr√©production, pas √† un bug."
  }
}
